# 员工管理系统 v1.6.1.3 - 审批功能修复版

一个功能完善的 Django 员工管理系统，支持多级用户角色、任务区管理、请假审批、报告上传等功能。

## 🔥 v1.6.1.3 重要更新

本版本修复了请假审批功能和优化了报告上传界面！

**问题修复**：
- ✅ 修复了请假申请"查看"和"审批"功能报错的问题
- ✅ 创建了完整的请假申请详情页面和审批页面
- ✅ 优化了报告上传界面，删除了不必要的任务区选择字段
- ✅ 任务区现在自动从用户账号获取，提升用户体验

**详细说明**：请查看 [FIX_README_v1.6.1.3.md](FIX_README_v1.6.1.3.md)

**历史版本**：
- v1.6.1.2: 修复了用户登录问题 - [LOGIN_FIX_README_v1.6.1.2.md](LOGIN_FIX_README_v1.6.1.2.md)
- v1.6.1.1: 修复了自动焦点问题

## 快速开始

### Windows 系统（一键部署）

1. **首次部署**
   ```bash
   initial_deploy.bat
   ```
   
   这将自动完成：
   - 安装 Python 依赖包（包括 pypinyin）
   - 创建数据库表结构
   - 创建超级管理员账户

2. **启动服务器**
   ```bash
   start_server.bat
   ```

3. **访问系统**
   - 打开浏览器，访问：http://127.0.0.1:8000/
   
## 测试账号

所有账号统一密码：`123456`

| 用户名 | 角色 | 说明 |
|--------|------|------|
| superuser01 | 超级管理员 | 系统管理 |
| branch_manager01 | 任务区负责人 | 任务区管理 |
| test_employee | 普通员工 | 测试员工功能 |
| test_manager | 任务区负责人 | 测试管理功能 |

### 手动部署（Linux/macOS）

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 数据库迁移
python manage.py makemigrations
python manage.py migrate

# 3. 创建超级用户
python manage.py createsuperuser

# 4. 启动服务器
python manage.py runserver
```

## 数据清洗工具

如果数据库中存在无效的任务区数据，运行：

```bash
python cleanup_invalid_task_areas.py
```

该脚本将：
- 检测并删除无效的任务区名称
- 解除用户与无效任务区的关联
- 显示详细的清理报告

## 主要功能

### 用户角色系统

1. **超级管理员** (Superuser)
   - 全局系统管理权限
   - 可以管理所有用户和任务区
   - 创建/编辑/删除任何用户

2. **总部负责人** (Head Manager)
   - 管辖多个任务区
   - 可以管理所属任务区的成员
   - 查看所管辖任务区的数据

3. **任务区经理** (Task Area Manager)
   - 管理单个任务区
   - 管理本任务区的普通员工
   - 查看本任务区的数据

4. **普通员工** (Employee)
   - 基本系统访问权限
   - 查看个人信息

### 任务区管理

- 创建和管理任务区
- 为用户分配任务区
- 总部负责人可管辖多个任务区
- 自动过滤无效数据

### 用户管理

- 创建新用户
- 编辑用户信息（姓名、邮箱、角色、任务区等）
- 设置用户角色和权限
- 分配部门、职位、任务区
- 启用/禁用用户账户
- 删除用户

### 搜索和筛选 ✨

- 按姓名、用户名、邮箱、部门、职位搜索
- 按角色筛选
- 按任务区筛选
- 实时搜索结果
- 基于权限的智能筛选

### 智能排序 🔄

- **超级管理员**：总部负责人 → 任务区（拼音） → 角色 → 姓氏（拼音）
- **总部负责人**：任务区（拼音） → 角色 → 姓氏（拼音）
- **任务区负责人**：姓氏（拼音）
- 基于中文拼音的自然排序

## 项目结构

```
employee_management_v1.4.3_FINAL/
├── accounts/              # 用户认证和模型
├── dashboard/            # 主仪表盘和管理功能
├── templates/            # HTML 模板
├── static/               # 静态文件 (CSS, JS, 图片)
├── employee_management/  # 项目配置
├── db.sqlite3            # SQLite 数据库
├── manage.py             # Django 管理命令
├── requirements.txt      # Python 依赖
├── initial_deploy.bat    # Windows 首次部署脚本
├── start_server.bat      # Windows 启动脚本
├── cleanup_invalid_task_areas.py  # 数据清洗工具
└── README.md             # 项目说明文档
```

## 常见问题

### 1. 如何重置管理员密码？

```bash
python manage.py changepassword admin
```

### 2. 如何清除无效数据？

```bash
python cleanup_invalid_task_areas.py
```

### 3. 页面修改后不生效？

- 按 `Ctrl + F5` 强制刷新浏览器
- 清除浏览器缓存
- 重启 Django 服务器

### 4. 如何备份数据？

直接复制 `db.sqlite3` 文件即可。

### 5. 如何恢复数据？

将备份的 `db.sqlite3` 文件覆盖到项目目录。

### 6. pypinyin 安装失败？

```bash
pip install --upgrade pip
pip install pypinyin>=0.49.0
```

## 注意事项

1. **首次使用**：请务必运行 `initial_deploy.bat` 进行初始化
2. **密码安全**：首次登录后请立即修改默认密码
3. **数据备份**：定期备份 `db.sqlite3` 文件
4. **生产环境**：本系统使用 Django 开发服务器，仅适用于小型团队内部使用
5. **权限管理**：请谨慎分配超级管理员和总部负责人权限
6. **pypinyin 依赖**：必须安装 pypinyin 才能使用排序功能

## 版本历史

### v1.6.1.2 (2025-11-02) 🔥
- **[关键修复]** 修复用户登录问题
- 修复密码未正确加密导致的认证失败
- 所有用户统一密码为 `123456`
- 新增用户诊断和测试工具
- 密码使用 PBKDF2-SHA256 算法（600000次迭代）

### v1.6.1.1
- 修复自动聚焦问题

### v1.4.3 (2025-10-22)
- 删除“员工地图”模块
- 新增员工列表搜索功能
- 新增员工列表筛选功能（任务区、角色）
- 新增智能排序功能（基于中文拼音）
- 添加 pypinyin 依赖

### v1.4.2 (2025-10-22)
- 重构员工列表表格，拆分"工作信息"列为独立的"任务区"、"部门"、"职位"列
- 调整列顺序，任务区列现在显示在部门列之前

### v1.4.1 (2025-10-22)
- 修复总部负责人管辖任务区编辑问题
- 修复数据清洗脚本导入错误
- 增强 UI 中的数据验证，防止无效数据显示

### v1.4.0
- 初始版本发布
- 完成核心功能开发

## 技术支持

如遇到问题，请提供：
1. 错误截图
2. 详细的操作步骤
3. 系统环境信息（Windows 版本、Python 版本等）
4. pypinyin 安装状态

---

**开发者**: MiniMax Agent  
**版本**: v1.6.1.2  
**更新日期**: 2025-11-02
