{% extends 'base.html' %}

{% block title %}员工位置地图{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-map me-2"></i>员工位置地图</h4>
                    <div class="badge bg-primary fs-6">共 {{ employee_count }} 人</div>
                </div>
                <div class="card-body p-0">
                    <!-- 搜索工具栏 -->
                    <div class="search-toolbar p-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control" 
                                           id="employeeSearchInput" 
                                           placeholder="搜索员工姓名..."
                                           autocomplete="off">
                                    <button class="btn btn-outline-secondary" 
                                            type="button" 
                                            id="clearSearchBtn"
                                            title="清除搜索">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-primary btn-sm" onclick="fitAllMarkers()">
                                    <i class="fas fa-expand-arrows-alt me-1"></i>查看全部
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="refreshMap()">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 地图容器 -->
                    <div id="employeeMap" style="height: 500px; border-radius: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 员工列表 -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>员工位置列表</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>员工</th>
                                    <th>角色</th>
                                    <th>公司</th>
                                    <th>位置坐标</th>
                                    <th>地址</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<style>
.search-toolbar {
    background-color: #f8f9fa;
}

.popup-value {
    color: #333;
    font-size: 0.9em;
}

.role-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    color: white;
    font-weight: bold;
}

.role-badge.superuser { background: #f44336; }
.role-badge.head_manager { background: #ff9800; }
.role-badge.branch_manager { background: #4caf50; }
.role-badge.employee { background: #2196f3; }

.table .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.highlight-row {
    background-color: #fff3cd !important;
    transition: background-color 0.3s ease;
}
</style>

<script>
// 员工数据
const employeeLocations = {{ employee_locations|safe }};
let employeeMarkers = [];
let highlightedMarkerId = null;

console.log('员工位置数据:', employeeLocations);

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('员工地图页面初始化，员工数量:', employeeLocations.length);
    
    initEmployeeMap();
    populateEmployeeTable();
    setupSearchFunctionality();
});

// 初始化员工地图
function initEmployeeMap() {
    console.log('初始化员工地图');
    
    if (employeeLocations.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // 创建员工标记
    createEmployeeMarkers();
    
    // 更新统计信息
    updateMapStats();
}

// 显示无数据消息
function showNoDataMessage() {
    const mapContainer = document.getElementById('employeeMapContainer');
    mapContainer.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column;">
            <div style="text-align: center; color: #666;">
                <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                <h5>暂无员工位置数据</h5>
                <p>当前没有员工更新位置信息</p>
            </div>
        </div>
    `;
}

// 创建员工标记
function createEmployeeMarkers() {
    const markersContainer = document.getElementById('employeeMarkers');
    markersContainer.innerHTML = '';
    employeeMarkers = [];
    
    // 计算位置范围用于标记分布
    const lats = employeeLocations.map(emp => parseFloat(emp.latitude));
    const lngs = employeeLocations.map(emp => parseFloat(emp.longitude));
    
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLng = Math.min(...lngs);
    const maxLng = Math.max(...lngs);
    
    const latRange = maxLat - minLat || 0.01;
    const lngRange = maxLng - minLng || 0.01;
    
    employeeLocations.forEach((employee, index) => {
        const lat = parseFloat(employee.latitude);
        const lng = parseFloat(employee.longitude);
        
        // 计算标记在地图上的相对位置
        const relativeX = lngRange > 0 ? (lng - minLng) / lngRange : 0.5;
        const relativeY = latRange > 0 ? 1 - (lat - minLat) / latRange : 0.5;
        
        // 添加一些边距，避免标记贴边
        const margin = 0.1;
        const x = margin + relativeX * (1 - 2 * margin);
        const y = margin + relativeY * (1 - 2 * margin);
        
        createMarker(employee, x, y, index);
    });
}

// 创建单个标记
function createMarker(employee, x, y, index) {
    const marker = document.createElement('div');
    marker.className = `employee-marker role-${employee.role}`;
    marker.id = `marker-${index}`;
    
    // 设置位置
    marker.style.left = (x * 100) + '%';
    marker.style.top = (y * 100) + '%';
    
    // 显示员工姓名首字母
    const firstName = employee.first_name || employee.username.charAt(0);
    marker.textContent = firstName.charAt(0).toUpperCase();
    
    // 添加点击事件
    marker.addEventListener('click', function() {
        showEmployeePopup(employee, this);
        highlightMarker(index);
        highlightTableRow(index);
    });
    
    // 添加悬停效果
    marker.title = `${employee.first_name} ${employee.last_name} - ${employee.role}`;
    
    document.getElementById('employeeMarkers').appendChild(marker);
    employeeMarkers.push({ element: marker, data: employee });
}

// 显示员工信息弹窗
function showEmployeePopup(employee, markerElement) {
    const popup = document.getElementById('employeePopup');
    const title = popup.querySelector('.popup-title');
    const content = popup.querySelector('.popup-content');
    
    title.textContent = `${employee.first_name} ${employee.last_name}`;
    
    content.innerHTML = `
        <div class="popup-item">
            <span class="popup-label">角色:</span>
            <span class="popup-value">
                <span class="role-badge ${employee.role}">${getRoleDisplayName(employee.role)}</span>
            </span>
        </div>
        <div class="popup-item">
            <span class="popup-label">公司:</span>
            <span class="popup-value">${employee.company || '-'}</span>
        </div>
        <div class="popup-item">
            <span class="popup-label">坐标:</span>
            <span class="popup-value">${parseFloat(employee.latitude).toFixed(4)}, ${parseFloat(employee.longitude).toFixed(4)}</span>
        </div>
        <div class="popup-item">
            <span class="popup-label">地址:</span>
            <span class="popup-value">${employee.address || '未设置'}</span>
        </div>
        <div class="popup-item">
            <span class="popup-label">更新:</span>
            <span class="popup-value">${employee.updated_at || '未更新'}</span>
        </div>
    `;
    
    // 计算弹窗位置
    const markerRect = markerElement.getBoundingClientRect();
    const mapRect = document.getElementById('employeeMapContainer').getBoundingClientRect();
    
    const relativeX = (markerRect.left - mapRect.left) / mapRect.width;
    const relativeY = (markerRect.top - mapRect.top) / mapRect.height;
    
    let popupX = relativeX * 100;
    let popupY = relativeY * 100;
    
    // 调整位置避免超出边界
    if (popupX > 60) popupX -= 30;
    if (popupY > 60) popupY -= 20;
    
    popup.style.left = popupX + '%';
    popup.style.top = popupY + '%';
    popup.style.display = 'block';
}

// 隐藏员工信息弹窗
function hideEmployeePopup() {
    document.getElementById('employeePopup').style.display = 'none';
    clearHighlights();
}

// 高亮标记
function highlightMarker(markerId) {
    // 清除之前的高亮
    clearMarkerHighlights();
    
    // 高亮当前标记
    const marker = document.getElementById(`marker-${markerId}`);
    if (marker) {
        marker.classList.add('highlighted');
        highlightedMarkerId = markerId;
    }
}

// 清除标记高亮
function clearMarkerHighlights() {
    employeeMarkers.forEach(markerInfo => {
        markerInfo.element.classList.remove('highlighted');
    });
    highlightedMarkerId = null;
}

// 清除所有高亮
function clearHighlights() {
    clearMarkerHighlights();
    clearTableHighlights();
}

// 填充员工表格
function populateEmployeeTable() {
    const tbody = document.getElementById('employeeTableBody');
    tbody.innerHTML = '';
    
    employeeLocations.forEach((employee, index) => {
        const row = document.createElement('tr');
        row.id = `row-${index}`;
        row.innerHTML = `
            <td>
                <div>
                    <strong>${employee.first_name} ${employee.last_name}</strong>
                    <br><small class="text-muted">${employee.username}</small>
                </div>
            </td>
            <td>
                <span class="role-badge ${employee.role}">${getRoleDisplayName(employee.role)}</span>
            </td>
            <td>${employee.company || '-'}</td>
            <td>
                <small class="text-monospace">
                    ${parseFloat(employee.latitude).toFixed(4)}<br>
                    ${parseFloat(employee.longitude).toFixed(4)}
                </small>
            </td>
            <td>
                <small>${employee.address || '未设置地址'}</small>
            </td>
            <td>
                <small>${employee.updated_at || '未更新'}</small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="locateEmployee(${index})" title="在地图上定位">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// 在地图上定位员工
function locateEmployee(index) {
    const marker = document.getElementById(`marker-${index}`);
    if (marker) {
        // 滚动到地图区域
        document.getElementById('employeeMapContainer').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // 延迟高亮，等待滚动完成
        setTimeout(() => {
            highlightMarker(index);
            highlightTableRow(index);
            
            // 显示员工信息
            const employee = employeeLocations[index];
            showEmployeePopup(employee, marker);
        }, 500);
    }
}

// 高亮表格行
function highlightTableRow(index) {
    clearTableHighlights();
    const row = document.getElementById(`row-${index}`);
    if (row) {
        row.classList.add('highlight-row');
    }
}

// 清除表格高亮
function clearTableHighlights() {
    const highlightedRows = document.querySelectorAll('.highlight-row');
    highlightedRows.forEach(row => row.classList.remove('highlight-row'));
}

// 设置搜索功能
function setupSearchFunctionality() {
    const searchInput = document.getElementById('employeeSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    searchInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        filterEmployees(keyword);
    });
    
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        filterEmployees('');
    });
}

// 过滤员工
function filterEmployees(keyword) {
    const rows = document.querySelectorAll('#employeeTableBody tr');
    const markers = employeeMarkers;
    
    let visibleCount = 0;
    
    rows.forEach((row, index) => {
        const employee = employeeLocations[index];
        const searchText = `${employee.first_name} ${employee.last_name} ${employee.username} ${employee.role} ${employee.company || ''}`.toLowerCase();
        
        const isVisible = keyword === '' || searchText.includes(keyword);
        
        // 显示/隐藏表格行
        row.style.display = isVisible ? '' : 'none';
        
        // 显示/隐藏地图标记
        if (markers[index]) {
            markers[index].element.style.display = isVisible ? 'block' : 'none';
        }
        
        if (isVisible) visibleCount++;
    });
    
    // 更新统计
    document.getElementById('locatedEmployees').textContent = visibleCount;
}

// 获取角色显示名称
function getRoleDisplayName(role) {
    const roleNames = {
        'superuser': '超级管理员',
        'head_manager': '总部负责人',
        'branch_manager': '分公司负责人',
        'employee': '普通员工'
    };
    return roleNames[role] || role;
}

// 更新地图统计信息
function updateMapStats() {
    document.getElementById('totalEmployees').textContent = employeeLocations.length;
    document.getElementById('locatedEmployees').textContent = employeeLocations.length;
}

// 查看全部标记
function fitAllMarkers() {
    // 重置搜索
    document.getElementById('employeeSearchInput').value = '';
    filterEmployees('');
    
    // 清除高亮
    clearHighlights();
    hideEmployeePopup();
    
    console.log('已重置地图视图');
}

// 刷新地图
function refreshMap() {
    console.log('刷新地图');
    location.reload();
}

// 缩放控制
let currentZoom = 50;

function adjustZoom(direction) {
    const zoomStep = 10;
    const minZoom = 25;
    const maxZoom = 200;
    
    if (direction === '+' && currentZoom < maxZoom) {
        currentZoom += zoomStep;
    } else if (direction === '-' && currentZoom > minZoom) {
        currentZoom -= zoomStep;
    }
    
    applyZoom();
}

function resetZoom() {
    currentZoom = 50;
    applyZoom();
}

function applyZoom() {
    const mapContainer = document.getElementById('employeeMapContainer');
    const zoomInfo = document.querySelector('.zoom-info');
    
    // 更新缩放信息显示
    zoomInfo.textContent = `缩放: ${currentZoom}%`;
    
    // 应用缩放变换（这里主要是视觉效果，实际标记位置保持不变）
    const features = document.querySelector('.map-features');
    const markers = document.getElementById('employeeMarkers');
    
    const scale = currentZoom / 50; // 基准缩放为50%
    
    if (features) {
        features.style.transform = `scale(${scale})`;
    }
    
    // 调整标记大小以保持可见性
    const allMarkers = document.querySelectorAll('.employee-marker');
    allMarkers.forEach(marker => {
        const baseSize = 40;
        const newSize = Math.max(25, baseSize / scale);
        marker.style.width = newSize + 'px';
        marker.style.height = newSize + 'px';
        marker.style.fontSize = Math.max(10, 12 / scale) + 'px';
    });
    
    console.log(`缩放调整为: ${currentZoom}%`);
}

// 点击地图空白区域隐藏弹窗
document.getElementById('employeeMapContainer').addEventListener('click', function(e) {
    if (e.target === this || e.target.classList.contains('map-background') || e.target.classList.contains('map-grid')) {
        hideEmployeePopup();
    }
});
</script>
{% endblock %}
